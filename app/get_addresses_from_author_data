# %%
import json
import pandas as pd
from tqdm import tqdm
from get_address import search_place, filter_best_match

# %%
with open('../config.json', 'r') as file:
    config = json.load(file)
google_maps_places_api_key = config['apiKeys']['googleMapsPlaces']

# %%
result_df = pd.read_pickle('./outputs/addresses_from_names/rneasy_authors.pkl')
print("RESULT DF:\n", result_df)

# %%
rneasy_df = pd.read_csv('/Users/nicoletrieu/Documents/zymo/metadata-scraper/app/data/rneasy_20_23.csv')
print("RNEASY DF:\n", rneasy_df)

# %%
filtered_df = result_df[result_df['lastName'].isin(rneasy_df["LastName"])]
print("FILTERED DF:\n", filtered_df)

# %%
deduped_filtered_df = filtered_df.drop_duplicates()
print("DEDUPED FILTERED DF:\n", deduped_filtered_df)

# %%
selected_columns_df = deduped_filtered_df[['lastName', 'affiliation', 'institute']]
print("SELECTED COLUMNS DF:\n", selected_columns_df)

# %%
author_dicts = selected_columns_df.to_dict('records')

# %%
print("length of author_dicts:", len(author_dicts))

# %%
print("first few author dicts:", author_dicts[:5])


# %%
def get_address_from_author_dicts(author_dicts: list, api_key: str):
    all_results = []

    for author_dict in tqdm(author_dicts, desc="Getting Addresses"):
        author_results = []

        for author in author_dict["authorList"]:
            for key in ['affiliation', 'institute']:
                if author.get(key, "") == "Unparsed":  # Skip 'Unparsed' institute values
                    continue

                search_result = search_place(author[key], api_key)

                if search_result == {}:
                    continue  # Skip empty search result
                if search_result.get("error"):
                    print(search_result.get("message"))  # Log the error message
                    continue

                result_list = search_result.get("places", [])
                if not result_list:
                    continue  # Skip this place if no results found

                # Find the best match:
                best_match_address = filter_best_match(result_list, author[key])
                if best_match_address:
                    result_dict = {
                        "lastName": author.get('lastName'),
                        "affiliation": author.get('affiliation', "Unspecified"),
                        "institute": author.get('institute', "Unparsed"),
                        "address": best_match_address
                    }
                    author_results.append(result_dict)
                    break

        # Combine all publication results into the main results list
        all_results.extend(author_results)

    return all_results


# %%
address_dicts = get_address_from_author_dicts(author_dicts, google_maps_places_api_key)

# %%
address_df = pd.DataFrame(address_dicts)
address_df.to_pickle('./outputs/addresses_from_names/rneasy_addresses.pkl')

# %%
address_df = pd.read_pickle('./outputs/addresses_from_names/rneasy_addresses.pkl')
print("ADDRESS DF:\n", address_df)

